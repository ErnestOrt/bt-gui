<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>BikeTeam Profile</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>

<link th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
<link th:href="@{/css/bootstrap-responsive.min.css}" rel="stylesheet"/>
<link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,400,600" rel="stylesheet"/>
<link th:href="@{/css/font-awesome.css}" rel="stylesheet"/>
<link th:href="@{/css/style.css}" rel="stylesheet"/>
<link th:href="@{/css/pages/dashboard.css}" rel="stylesheet"/>
<link th:href="@{/css/jquery.datetimepicker.css}" rel="stylesheet"/>
<link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.3.0/bootstrap.min.css" />
<link th:href="@{/css/map.css}" rel="stylesheet"/>

<style type="text/css">
   .invalid {
	  background-color: #ffdddd;
	}
	
	.valid {
	  background-color: #ddffdd;
	}
</style>

</head>
<body>
	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="btn btn-navbar" data-toggle="collapse"
					data-target=".nav-collapse"><span class="icon-bar"></span><span
					class="icon-bar"></span><span class="icon-bar"></span> </a><a
					class="brand" href="index.html">Teambike</a>
				<div class="nav-collapse">
					<ul class="nav pull-right">
						<li class="dropdown"><a href="#" class="dropdown-toggle"
							data-toggle="dropdown"> Ernest Ortuño <b class="caret"></b></a>

							<ul class="dropdown-menu">
								<li><a href="javascript:;">Profile</a></li>
								<li><a href="javascript:;">Logout</a></li>
							</ul></li>
					</ul>
				</div>
			</div>
			<!--/.nav-collapse -->
		</div>
		<!-- /container -->
	</div>
	<!-- /navbar-inner -->
	
	<!-- /navbar -->
	<div class="subnavbar">

		<!-- /subnavbar-inner -->
	</div>
	<!-- /subnavbar -->
	<div class="main">
  <div class="main-inner">
    <div class="container">
      <div class="row">
        <div class="span6">
			<div class="widget">
	            <div class="widget-header"> <i class="icon-bookmark"></i>
	              <h3>What to see</h3>
	            </div>
	            <!-- /widget-header -->
	            <div class="widget-content">
		          <div class="shortcuts"> 
					<a href="./dashboard" class="shortcut"><i class="shortcut-icon icon-globe"></i><span class="shortcut-label">Team</span></a>
	                <a href="./profile" class="shortcut"><i class="shortcut-icon icon-user"></i><span class="shortcut-label">Profile</span></a>
	                <a href="./stages" class="shortcut shortcut-active"><i class="shortcut-icon icon-picture"></i><span class="shortcut-label">Stages</span></a>
	                <a href="./members" class="shortcut"><i class="shortcut-icon icon-group"></i> <span class="shortcut-label">Members</span></a>
	              </div>
	              <!-- /shortcuts --> 
	            </div>
	        </div>
	        
	        <div class="widget">
            <div class="widget-header"> <i class="icon-picture"></i>
              <h3>New Stage</h3>
            </div>
				<!-- /widget-header -->
				<div class="widget-content">
					<div class="control-group">
						<label class="control-label" for="firstname">Name</label>
						<div class="controls">
							
							<input type="text" class="span2" id="input-stage-name" placeholder="Bcn-Tarragona-Valls"></input>
						</div>
						<!-- /controls -->
					</div>
					<div class="control-group">											
						<label class="control-label" for="name">Total Km</label>
						<div class="controls">
							<input type="number" min="1" max="1000" class="span2" id="input-stage-kilomiters-total" placeholder="200" onchange="setIntervalsAltitude()"></input>
						</div>				
					</div>
					<div class="control-group">
						<label class="control-label" for="firstname">Date</label>
						<div class="controls">
							<input type="text" class="span2" id="datetimepicker"></input>
						</div>
						<!-- /controls -->
					</div>
					<div class="control-group">											
						<label class="control-label" for="name">Altitudes</label>
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-0"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-0" onfocus="getAltitude('0')"></input>
							<input type="hidden" id="input-stage-latitude-0"></input>
							<input type="hidden" id="input-stage-longitude-0"></input>
						</div>
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-1"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-1" onfocus="getAltitude('1')"></input>
							<input type="hidden" id="input-stage-latitude-1"></input>
							<input type="hidden" id="input-stage-longitude-1"></input>
						</div>
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-2"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-2" onfocus="getAltitude('2')"></input>
							<input type="hidden" id="input-stage-latitude-2"></input>
							<input type="hidden" id="input-stage-longitude-2"></input>
						</div>	
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-3"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-3" onfocus="getAltitude('3')"></input>
							<input type="hidden" id="input-stage-latitude-3"></input>
							<input type="hidden" id="input-stage-longitude-3"></input>
						</div>
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-4"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-4" onfocus="getAltitude('4')"></input>
							<input type="hidden" id="input-stage-latitude-4"></input>
							<input type="hidden" id="input-stage-longitude-4"></input>
						</div>
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-5"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-5" onfocus="getAltitude('5')"></input>
							<input type="hidden" id="input-stage-latitude-5"></input>
							<input type="hidden" id="input-stage-longitude-5"></input>
						</div>
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-6"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-6" onfocus="getAltitude('6')"></input>
							<input type="hidden" id="input-stage-latitude-6"></input>
							<input type="hidden" id="input-stage-longitude-6"></input>
						</div>
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-7"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-7" onfocus="getAltitude('7')"></input>
							<input type="hidden" id="input-stage-latitude-7"></input>
							<input type="hidden" id="input-stage-longitude-7"></input>
						</div>
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-8"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-8" onfocus="getAltitude('8')"></input>
							<input type="hidden" id="input-stage-latitude-8"></input>
							<input type="hidden" id="input-stage-longitude-8"></input>
						</div>
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-9"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-9" onfocus="getAltitude('9')"></input>
							<input type="hidden" id="input-stage-latitude-9"></input>
							<input type="hidden" id="input-stage-longitude-9"></input>
						</div>
						<div class="controls">
							<span>Km:&nbsp;&nbsp;&nbsp;</span>
							<input type="text" min="1" max="10" class="span2" id="input-stage-kilomiters-10"></input>
							<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Elevation:&nbsp;&nbsp;&nbsp;</span>
							<input type="number" min="1" max="10" class="span2" id="input-stage-altitude-10" onfocus="getAltitude('10')"></input>
							<input type="hidden" id="input-stage-latitude-10"></input>
							<input type="hidden" id="input-stage-longitude-10"></input>
						</div>
						<div class="form-actions">
	                        <button class="btn btn-success" onclick="createStage()">Create</button>
						</div>		
					</div>
					<div id="modal-elevation" class="modal hide fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" >
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
							<h3 id="modal-elevation-title"></h3>
						</div>
						<div class="modal-body">							
							<div id="map" style="height:400px;"></div>				
						</div>
						<div class="modal-footer">
							<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
						</div>
					</div>
				</div>
				<!-- /widget-content --> 
          </div>
        </div>
        <!-- /span6 -->
        <div class="span6">
           <div class="widget" th:each="stage : ${stages}">
            <div class="widget-header"> <i class="icon-picture"></i>
              <h3><a th:href="'/stage/' + ${stage.id}" th:text="${stage.name} + '[' + ${stage.date} + ']'"></a></h3>
            </div>
            <!-- /widget-header -->
            <div class="widget-content">
               <canvas th:id="'area-chart-' + ${stage.id}" class="chart-holder" height="250" width="538"> </canvas>
               <div id="big_stats" class="cf">
                 <div class="stat"> <i class="icon-group"></i> <span class="value" th:text="${stage.joinedMembers.size()}"></span> Memebers </div>
                 <div class="stat"> <i class="icon-road"></i> <span class="value" th:text="${stage.kilomitersTotal}"></span> Km </div>
               </div>
            </div>
            <!-- /widget-content --> 
          </div>

          <!-- /widget -->
        </div>
        <!-- /span6 --> 
      </div>
      <!-- /row --> 
    </div>
    <!-- /container --> 
  </div>
  <!-- /main-inner --> 
</div>
<!-- /main -->

    	<!-- /main -->
	<div class="extra">
		<div class="extra-inner">
			<div class="container">
				<div class="row">
					<div class="span3">
						<h4>Support</h4>
						<ul>
							<li><a href="javascript:;">Frequently Asked Questions</a></li>
							<li><a href="javascript:;">Ask a Question</a></li>
							<li><a href="javascript:;">Video Tutorial</a></li>
							<li><a href="javascript:;">Feedback</a></li>
						</ul>
					</div>
					<!-- /span3 -->

					<!-- /span3 -->
				</div>
				<!-- /row -->
			</div>
			<!-- /container -->
		</div>
		<!-- /extra-inner -->
	</div>
	<!-- /extra -->
	<div class="footer">
		<div class="footer-inner">
			<div class="container">
				<div class="row">
					<div class="span12"> &copy; 2016 BikeTeam</div>
					<!-- /span12 -->
				</div>
				<!-- /row -->
			</div>
			<!-- /container -->
		</div>
		<!-- /footer-inner -->
	</div>
	<!-- /footer -->
	<!-- Le javascript
================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	
    

    
	<script th:src="@{/js/jquery-1.7.2.min.js}"></script> 
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script th:src="@{/js/gmaps.js}"></script>


	<script th:src="@{/js/excanvas.min.js}"></script>
	<script th:src="@{/js/chart.min.js}" type="text/javascript"></script>
	
	<script th:src="@{/js/base.js}"></script>
	<script th:src="@{/js/jquery.datetimepicker.full.js}"></script>
	
	
    
    <script type="text/javascript">
      
      var map = null;
      var stageElevationSelected;  
      
      $('#modal-elevation').on('shown.bs.modal', function (e) {
    	  if(map == null){
	    	  map = new GMaps(
	    	    {
	    	     el: '#map',
	    	     lat:47.366009,
	    	     lng:9.909770,
	    	     zoom:1,
	    	     click:function (event) {
	    	    	 $('#input-stage-latitude-' + stageElevationSelected).val(event.latLng.lat());
	    	    	 $('#input-stage-longitude-' + stageElevationSelected).val(event.latLng.lng());
	    	    	 displayLocationElevation(event.latLng, elevator);
	    	    }
	    	  });
    	  }
    	})
    
    	var elevator = new google.maps.ElevationService;
      
    	function displayLocationElevation(location, elevator) {
			  altitude=0;
			  elevator.getElevationForLocations({
			    'locations': [location]
			  }, function(results, status) {
			    
			    if (status === google.maps.ElevationStatus.OK) {
			      // Retrieve the first result
			      if (results[0]) {
			    	  $('#input-stage-altitude-' + stageElevationSelected).val(Math.round(results[0].elevation * 100) / 100);
			    	  
			      } 
			    }
			    $('#modal-elevation').modal('hide');
			  });
    	}

  </script>
    
    <script th:src="@{/js/bootstrap.js}"></script>

	
    <script th:inline="javascript">
    
    /*<![CDATA[*/
	var lineChartData
	var valuesStage =[];
	var valuesBackground =[];
	var labelsKilomiters = [];
    var stagesList = [[${stages}]]
    
    for (indexStage = 0; indexStage < stagesList.length; indexStage++) {
    	valuesStage =[];
    	valuesBackground =[];
    	labelsKilomiters = [];
    	
    	valuesBackground.push(0);
    	valuesBackground.push(1000);
    	
    	for(indexStagePoint = 0; indexStagePoint < stagesList[indexStage].stagePoints.length; indexStagePoint++){
    		labelsKilomiters.push(stagesList[indexStage].stagePoints[indexStagePoint].kilomiter);
    		valuesStage.push(stagesList[indexStage].stagePoints[indexStagePoint].altitude);
		    if(indexStagePoint>=2){
				valuesBackground.push(0);
		  	}

    	}
    	
    	lineChartData = {
                labels:  labelsKilomiters,
                datasets: [
					{
					    fillColor: "rgba(255,255,255,0)",
     				    strokeColor: "rgba(255,255,255,0)",
     				    pointColor: "rgba(255,255,255,0)",
     				    pointStrokeColor: "#FFFFFF",
     				    pointHighlightFill: "#FFFFFF",
     				    pointHighlightStroke: "rgba(255,255,255,0)",
					    data: valuesBackground
					},
    				{
    				    fillColor: "rgba(151,187,205,0.5)",
    				    strokeColor: "rgba(151,187,205,1)",
    				    pointColor: "rgba(151,187,205,1)",
    				    pointStrokeColor: "#fff",
    				    data: valuesStage
    				}
    			]

            }
    	new Chart(document.getElementById("area-chart-" + stagesList[indexStage].id).getContext("2d")).Line(lineChartData);
    }
    
	/*]]>*/
 
    $('#datetimepicker').datetimepicker({
    	dayOfWeekStart : 1,
    	lang:'en'
    	});
    
    /*<![CDATA[*/
    $( document ).ready(function() {
        for(i=0;i<11;i++) {
        	$('#input-stage-kilomiters-' + i).prop('disabled', true);
        	$('#input-stage-altitude-' + i).prop('disabled', true);
        }
    });
    /*]]>*/
    
    function getAltitude(number){
    	
    	$('#modal-elevation-title').text('Click on km '+$('#input-stage-kilomiters-'+number).val() + ' to get elevation');
    	$('#modal-elevation').modal('show');
    	stageElevationSelected=number;
    }
    
    function setIntervalsAltitude(){
    	
    	if($('#input-stage-kilomiters-total').val() != ""){
	    	var delta = $('#input-stage-kilomiters-total').val()/10;
	    	/*<![CDATA[*/
   	        for(i=0;i<11;i++) {  	        	
   	        	$('#input-stage-altitude-' + i).prop('disabled', false);
   	        	$('#input-stage-kilomiters-' + i).val(Math.round(delta * i * 100) / 100);
   	        }
    	    /*]]>*/
    	}else{
    		/*<![CDATA[*/
   	        for(i=0;i<11;i++) {  	        	
   	        	$('#input-stage-altitude-' + i).prop('disabled', true);
   	        	$('#input-stage-kilomiters-' + i).val("");
   	        	$('#input-stage-altitude-' + i).val("");
   	        }
    	    /*]]>*/
    	}
    }
    
    
    function createStage(){
    	if(areCreateFiledsFilled()){
    		var kilomitersArray = [];
        	var elevationArray = [];
        	var longitudeArray = [];
        	var latitudeArray = [];
        	
        	/*<![CDATA[*/
            for(i=0;i<11;i++) {  	        	
            	kilomitersArray.push($('#input-stage-kilomiters-' + i).val());
            	elevationArray.push($('#input-stage-altitude-' + i).val());
            	longitudeArray.push($('#input-stage-longitude-' + i).val());
            	latitudeArray.push($('#input-stage-latitude-' + i).val());
            }
    	    /*]]>*/
    	   
       		$.ajax({
       		    url : "/stages/create",
       		    type: "POST",
       		    data : {name: $("#input-stage-name").val(),
    	   		    	date: $("#datetimepicker").val(),
    	   		    	kilomitersTotal: $("#input-stage-kilomiters-total").val(),
    	   		    	kilomiters: kilomitersArray.toString(),
    	   		    	elevation: elevationArray.toString(),
    	   		    	longitude: longitudeArray.toString(),
    	   		    	latitude: latitudeArray.toString()},
       		    success: function(data, textStatus, jqXHR) { location.reload(); }
       		});	
    	}
    }
    
    function areCreateFiledsFilled(){
    	var result = true;
    	/*<![CDATA[*/
        for(i=0;i<11;i++) {  	
        	result = validateField('input-stage-altitude-' + i, result);
        	result = validateField('input-stage-kilomiters-' + i, result);
        }
	    /*]]>*/
	    
	    result = validateField('input-stage-name', result);
	    result = validateField('datetimepicker', result);
	    result = validateField('input-stage-kilomiters-total', result);
        
        return result;
    }
    
    function validateField(fieldId, previosResult){
    	var result = true;
    	if($('#' + fieldId).val()==""){
    		$('#' + fieldId).removeClass("invalid").removeClass("valid").addClass("invalid");
     		result = false;
     	}else{
     		$('#' + fieldId).removeClass("invalid").removeClass("valid").addClass("valid");
     	}
    	if(previosResult == false){
    		result = false;
    	}
    	return result;
    }
  </script>
</body>
</html>
